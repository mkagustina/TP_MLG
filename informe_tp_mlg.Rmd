---
fontsize: 11pt
output: 
  pdf_document: 
    latex_engine: xelatex
    keep_tex: true
    toc: false
    fig_caption: true  
geometry: "left=3cm,right=3cm,top=3cm,bottom=3cm"
#titlepage: true 
lang: es-ES  
editor_options: 
  chunk_output_type: console
header-includes:
  - \usepackage{caption}
  - \captionsetup[table]{position=bottom,labelformat=default,labelsep=colon,name=Tabla}
  - \captionsetup[figure]{labelformat=default,labelsep=colon,name=Figura}
include-in-header:
            - text: |
                \usepackage{float}
                \floatplacement{figure}{H} 
---

\begin{titlepage}
    \centering
    % Logo
    \includegraphics[width=0.7\textwidth]{logo_facultad.png}\par
    % Espacio entre logo y título principal
    \vspace{3cm}
    % Título principal
    {\scshape\Huge Trabajo Práctico de Modelos Lineales Generalizados \par}
    \vfill
    % Carrera y Alumnos
    {\Large Integrantes: \\[0.15cm]
     Candela, Ornella \\[0.15cm]
     Mac Kay, Agustina \\[0.15cm]
     Ovando, Francisco \par}
    \vspace{1cm}
    {\Large Licenciatura en Estadística \par}
    % Fecha abajo del todo
    \vspace{0.15cm}
    {\large Año 2025 \par}
\end{titlepage}


```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.align="center", echo = FALSE, 
                      warning = FALSE, message = FALSE, 
                      fig.width = 5.5, fig.height = 2.8,  
                      fig.align = "center", dpi = 300)
```

```{r}
# Carga de librerías
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(forcats)
library(MASS)
library(statmod)
library(kableExtra)
library(pROC)
library(caret)
library(broom) # Extrae info de los modelos ajustados


# Estilo global de gráficos ggplot2
theme_set(
  theme_bw(base_size = 11) +
    theme(
      plot.title = element_blank(),           # sin título principal
      plot.subtitle = element_blank(),        # sin subtítulo
      plot.caption = element_blank(),         # caption lo maneja knitr
      axis.title = element_text(size = 10, face = "bold"),
      axis.text = element_text(size = 9),
      legend.title = element_text(size = 10, face = "bold"),
      legend.text = element_text(size = 9),
      panel.grid.minor = element_blank(),
      panel.grid.major = element_line(linewidth = 0.3, colour = "grey85"),
      strip.text = element_text(size = 10)    # para facet_wrap/facet_grid
    )
)

options(scipen = 8) # Desactiva notación científica
```

```{r}
# Carga de datos
diabetes <- read_csv("diabetes.csv")
```

```{r}
# Modificacion de la base
datos_crudo <- diabetes %>% 
  dplyr::rename(
    glucosa = "Glucose",
    presion = "BloodPressure",
    piel = "SkinThickness",
    insulina = "Insulin",
    imc = "BMI",
    dpf = "DiabetesPedigreeFunction",
    edad = "Age",
    diabetes = "outcome"
    ) %>%
  filter(
    edad < 80, 
    presion > 0,
    insulina > 0,
    glucosa > 0, 
    imc > 0
    )%>%
  mutate(
    embarazo = factor(case_when(
      Pregnancies == 0 ~ "0",
      Pregnancies <= 3 ~ "1",
      T ~ "2")),
    obesidad = factor(case_when(
      imc < 30 ~ "0",
      T ~ "1")),
    glucosa = factor(case_when(
      glucosa > 100 ~ "1",
      T ~ "0")),
    presion = factor(case_when(
      presion > 80 ~ "1",
      T ~ "0")),
    dpf = factor(case_when(
      dpf > 0.5 ~ "1",
      T ~ "0"))
    )

datos <-  datos_crudo %>% 
  dplyr::select(edad, glucosa, presion, dpf, embarazo, obesidad,
                diabetes)
datos <- as.data.frame(datos)
```

```{r}
# Separación del dataset en training y validation sets
set.seed(8)

# Training set
datos_train <- datos %>% slice_sample(prop = 0.85)

# Validation set
datos_val <- datos %>% 
  filter(!row_number() %in% as.numeric(rownames(datos_train)))
```

# Introducción

La diabetes es una enfermedad metabólica crónica caracterizada por niveles elevados de glucosa en sangre, consecuencia de una producción insuficiente de insulina o de una resistencia del organismo a su acción. Esta condición puede derivar en complicaciones cardiovasculares, renales, neurológicas y visuales, afectando de manera significativa la calidad de vida de quienes la padecen.

Dada la relevancia de esta enfermedad en términos de salud pública y su estrecha relación con factores fisiológicos y de estilo de vida, resulta fundamental comprender qué características individuales se asocian a un mayor riesgo de padecerla.

En este trabajo se busca identificar los factores con mayor incidencia en la probabilidad de padecer diabetes, aplicando un modelo lineal generalizado con enlace logit sobre una muestra de mujeres adultas.

# Material y métodos

El presente trabajo tiene como objetivo analizar los factores asociados a la presencia de diabetes en 391 mujeres mayores de 21 años, a través de un modelo lineal generalizado con respuesta binaria. De los 391 datos disponibles, la muestra se dividió para el análisis predictivo. Se utilizó un conjunto de entrenamiento de 332 observaciones para ajustar el modelo. Las 59 observaciones restantes se reservaron como conjunto de validación para evaluar la capacidad predictiva. La variable respuesta analizada toma el valor 1 si la persona presenta diagnóstico de diabetes y 0 en caso contrario, por lo que se asume una distribución Bernoulli para cada observación.

Las variables explicativas incluidas en el análisis se describen a continuación:

\begin{itemize}
  \item \textbf{Edad}: medida en años. Es una variable cuantitativa continua que permite evaluar el efecto del envejecimiento sobre la probabilidad de desarrollar diabetes.

  \item \textbf{Embarazo}: número de veces que la mujer ha estado embarazada, categorizada en tres niveles:
  \begin{itemize}
    \item “0”: ninguna gestación
    \item “1”: entre una y tres gestaciones
    \item “2”: más de tres gestaciones
  \end{itemize}

  \item \textbf{Glucosa}: concentración de glucosa en ayunas. Fue categorizada en dos niveles:
  \begin{itemize}
    \item “0”: valores normales ($≤$ 100 mg/dL)
    \item “1”: valores elevados ($>$ 100 mg/dL)
  \end{itemize}

  \item \textbf{Presión arterial}: presión diastólica medida en mmHg, clasificada en dos niveles:
  \begin{itemize}
    \item “0”: presión dentro del rango normal ($≤$ 80 mmHg)
    \item “1”: presión elevada ($>$ 80 mmHg)
  \end{itemize}

  \item \textbf{Obesidad}: medida a través del índice de masa corporal (IMC). Se definió con dos niveles:
  \begin{itemize}
    \item “0”: IMC menor a 30
    \item “1”: IMC igual o superior a 30
  \end{itemize}

  \item \textbf{Función de predisposición (DPF)}: índice que cuantifica la predisposición genética a la diabetes a partir del historial familiar. Fue dicotomizado en:
  \begin{itemize}
    \item “0”: valores bajos ($≤$ 0.5)
    \item “1”: valores altos ($>$ 0.5)
  \end{itemize}
\end{itemize}

## Análisis descriptivo

A continuación se presenta una visión general de las características clave de la población estudiada.

```{r}
tabla_diabetes <- datos %>%
  count(diabetes) %>%
  mutate(
    Categoria = ifelse(diabetes == 1, "Sí", "No"),
    Porcentaje = round(100 * n / sum(n), 2)
  ) %>%
  dplyr::select(Categoria, Frecuencia = n, Porcentaje) %>%
  bind_rows(
    tibble(
      Categoria = "Total",
      Frecuencia = sum(.$Frecuencia),
      Porcentaje = 100
    )
  )

# Mostrar tabla 
tabla_diabetes %>%
  kable(
    caption = "Frecuencias absolutas y relativas de diabetes",
    col.names = c("Diabetes", "Frecuencia", "Porcentaje (%)"),
    align = "c",
    format = "latex",    
    booktabs = TRUE       
  ) %>%
  kable_styling(
    latex_options = c("hold_position", "caption_position_bottom"),
    full_width = FALSE
  )
```

```{r, eval=FALSE}
# resumen general de variables
skim(datos)
```

```{r}
# Analisis variables explicativas categoricas

# Frecuencias absolutas y relativas de OBESIDAD
tabla_obesidad <- datos %>%
  count(obesidad) %>%
  mutate(
    Categoria = case_when(
      obesidad == 0 ~ "Peso Normal o sobrepeso",
      obesidad == 1 ~ "Obesidad",
    ),
    Porcentaje = round(100 * n / sum(n), 2)
  ) %>%
  dplyr::select(Categoria, Frecuencia = n, Porcentaje) %>% 
  # Agregar fila de totales
  rbind(c("Total", sum(.$Frecuencia), 100))

# Mostrar tabla 
tabla_obesidad %>%
  kable(
    caption = "Frecuencias absolutas y relativas de obesidad",
    col.names = c("Obesidad", "Frecuencia", "Porcentaje (%)"),
    align = "c",
    format = "latex",    
    booktabs = TRUE       
  ) %>%
  kable_styling(
    latex_options = c("hold_position", "caption_position_bottom"),
    full_width = FALSE
  )
```


```{r}
# Frecuencias absolutas y relativas de GLUCOSA
tabla_glucosa <- datos %>%
  count(glucosa) %>%
  mutate(
    Categoria = ifelse(glucosa == 1, "Elevada", "Normal"),
    Porcentaje = round(100 * n / sum(n), 2)
  ) %>%
  dplyr::select(Categoria, Frecuencia = n, Porcentaje) %>% 
  # Agregar fila de totales
  rbind(c("Total", sum(.$Frecuencia), 100))

# Mostrar tabla 
tabla_glucosa %>%
  kable(
    caption = "Frecuencias absolutas y relativas de glucosa",
    col.names = c("Glucosa", "Frecuencia", "Porcentaje (%)"),
    align = "c",
    format = "latex",     
    booktabs = TRUE       
  ) %>%
  kable_styling(
    latex_options = c("hold_position", "caption_position_bottom"),
    full_width = FALSE
  )
```


```{r}
# Frecuencias absolutas y relativas de PRESION
tabla_presion <- datos %>%
  count(presion) %>%
  mutate(
    Categoria = ifelse(presion == 1, "Elevada", "Normal"),
    Porcentaje = round(100 * n / sum(n), 2)
  ) %>%
  dplyr::select(Categoria, Frecuencia = n, Porcentaje) %>% 
  # Agregar fila de totales
  rbind(c("Total", sum(.$Frecuencia), 100))

# Mostrar tabla 
tabla_presion %>%
  kable(
    caption = "Frecuencias absolutas y relativas de presión",
    col.names = c("Presión", "Frecuencia", "Porcentaje (%)"),
    align = "c",
    format = "latex",     
    booktabs = TRUE       
  ) %>%
  kable_styling(
    latex_options = c("hold_position", "caption_position_bottom"),
    full_width = FALSE
  )
```


```{r}
# Frecuencias absolutas y relativas de DPF
tabla_dpf <- datos %>%
  count(dpf) %>%
  mutate(
    Categoria = ifelse(dpf == 1, "Riesgo alto", "Riesgo bajo"),
    Porcentaje = round(100 * n / sum(n), 2)
  ) %>%
  dplyr::select(Categoria, Frecuencia = n, Porcentaje) %>% 
  # Agregar fila de totales
  rbind(c("Total", sum(.$Frecuencia), 100))

# Mostrar tabla 
tabla_dpf %>%
  kable(
    caption = "Frecuencias absolutas y relativas de DPF",
    col.names = c("DPF", "Frecuencia", "Porcentaje (%)"),
    align = "c",
    format = "latex",     
    booktabs = TRUE       
  ) %>%
  kable_styling(
    latex_options = c("hold_position", "caption_position_bottom"),
    full_width = FALSE
  )
```


```{r}
# Frecuencias absolutas y relativas de EMBARAZO
tabla_embarazo <- datos %>%
  count(embarazo) %>%
  mutate(
    Categoria = case_when(
      embarazo == 0 ~ "Ninguno",
      embarazo == 1 ~ "1 a 3",
      embarazo == 2 ~ "Más de 3",
    ),
    Porcentaje = round(100 * n / sum(n), 2)
  ) %>%
  dplyr::select(Categoria, Frecuencia = n, Porcentaje) %>% 
  # Agregar fila de totales
  rbind(c("Total", sum(.$Frecuencia), 100))

# Mostrar tabla 
tabla_embarazo %>%
  kable(
    caption = "Frecuencias absolutas y relativas de embarazo",
    col.names = c("Embarazos", "Frecuencia", "Porcentaje (%)"),
    align = "c",
    format = "latex",    
    booktabs = TRUE       
  ) %>%
  kable_styling(
    latex_options = c("hold_position", "caption_position_bottom"),
    full_width = FALSE
  )
```


```{r}
# Tabla descriptiva de edad
tabla_edad <- datos %>%
  summarise(
    Media_edad = round(mean(edad),2),
    Mediana_edad = median(edad),
    DE_edad = round(sd(edad),2),
    Min_edad = min(edad),
    Max_edad = max(edad)
  ) %>%
  pivot_longer(everything()) %>%
  separate(name, into = c("Estadístico", "Variable"), sep = "_") %>%
  pivot_wider(names_from = Estadístico, values_from = value) %>%
  mutate(
    Variable = case_when(
      Variable == "edad" ~ "Edad",
      TRUE ~ Variable
    )
  ) %>%
  dplyr::select(Variable, Media, Mediana, DE, Min, Max)

# Mostrar tabla en formato LaTeX
tabla_edad %>%
  kable(
    caption = "Estadísticas descriptivas de la variable edad",
    col.names = c("Variable", "Media", "Mediana", "DE", "Mínimo", "Máximo"),
    align = "c",
    format = "latex",
    booktabs = TRUE
  ) %>%
  kable_styling(
    latex_options = c("hold_position", "caption_position_bottom"),
    full_width = FALSE
  )
```

\newpage

Los datos muestran que un 33.2% de la población estudiada tiene diabetes, con una alta prevalencia de obesidad (67%) y niveles elevados de glucosa (70.3%). Además, el 43% de los participantes tiene antecedentes familiares de diabetes, lo que podría indicar una predisposición genética relevante. Aunque la mayoría presenta presión arterial normal (80.1%), los factores como la obesidad, los niveles de glucosa y el historial familiar podrían ser más críticos para entender el riesgo de diabetes en esta población. 

Seguidamente, se presentan gráficos que permiten observar la relación entre la variable respuesta (presencia de diabetes) y distintas variables explicativas categóricas y continuas. Esta visualización facilita la detección de posibles asociaciones y patrones relevantes para el posterior análisis.

\newpage

```{r fig-1}
#| fig.cap: "Proporción de personas con diabetes según nivel de obesidad"
ggplot(datos, aes(x = obesidad, fill = factor(diabetes))) +
  geom_bar(position = "fill", width = 0.7) +
  scale_fill_manual(
    values = c("aquamarine3", "pink3"),
    name = "Diabetes",
    labels = c("No", "Sí")
  ) +
  scale_x_discrete(
    labels = c("0" = "Peso normal o sobrepeso", "1" = "Obesidad")
  ) +
  labs(
    x = "Nivel de obesidad",
    y = "Proporción"
  )
```

Se observa que la proporción de mujeres con diabetes es más alta para aquellas con obesidad en comparación a las pacientes sin obesidad.

```{r}
#| fig.cap: "Proporción de personas con diabetes según presión"
# PRESIÓN
ggplot(datos, aes(x = presion, fill = factor(diabetes))) +
  geom_bar(position = "fill", width = 0.7) +
  scale_fill_manual(
    values = c("aquamarine3", "pink3"),
    name = "Diabetes",
    labels = c("No", "Sí")
  ) +
  scale_x_discrete(
    labels = c(`0` = "Normal", `1` = "Elevada")
  ) +
  labs(
    x = "Presión",
    y = "Proporción"
  )
```

La presión elevada puede estar influyendo en la probabilidad de padecer diabetes, dado que se puede ver una proporción más alta de diabéticas en las mujeres con presión elevada que en aquellas con presión normal.

\newpage

```{r}
#| fig.cap: "Proporción de personas con diabetes según DPF"
ggplot(datos, aes(x = dpf, fill = factor(diabetes))) +
  geom_bar(position = "fill", width = 0.7) +
  scale_fill_manual(
    values = c("aquamarine3", "pink3"),
    name = "Diabetes",
    labels = c("No", "Sí")
  ) +
  scale_x_discrete(
    labels = c(`0` = "Riesgo bajo", `1` = "Riesgo alto")
  ) +
  labs(
    x = "DPF",
    y = "Proporción"
    )
```

Como es de esperarse, hay mayor proporción de diabéticas en aquellas mujeres con un DPF más alto comparando con las pacientes con DPF bajo. 

```{r}
#| fig.cap: "Proporción de personas con diabetes según nivel de glucosa"
ggplot(datos, aes(x = glucosa, fill = factor(diabetes))) +
  geom_bar(position = "fill", width = 0.7) +
  scale_fill_manual(
    values = c("aquamarine3", "pink3"),
    name = "Diabetes",
    labels = c("No", "Sí")
  ) +
  scale_x_discrete(
    labels = c(`0` = "Normal", `1` = "Elevada")
  ) +
  labs(
    x = "Nivel de glucosa",
    y = "Proporción"
    )
```

La relación entre la glucosa y la diabetes es directa por la naturaleza de la enfermedad, hay mayor proporción de diabéticas en pacientes con glucosa elevada que en aquellas con niveles de glucosa normales.

\newpage

```{r}
#| fig.cap: "Proporción de personas con diabetes según cantidad de embarazos"
ggplot(datos, aes(x = embarazo, fill = factor(diabetes))) +
  geom_bar(position = "fill", width = 0.7) +
  scale_fill_manual(
    values = c("aquamarine3", "pink3"),
    name = "Diabetes",
    labels = c("No", "Sí")
  ) +
  scale_x_discrete(
    labels = c(`0` = "Ninguno", `1` = "1 a 3", `2` = "4 o más")
  ) +
  labs(
    x = "Cantidad de embarazos",
    y = "Proporción"
  )
```

Parece haber un aumento en la proporción de mujeres con diabetes en aquellas que tuvieron 4 o más embarazos, y un descenso para las que tuvieron entre 1 y 3, en comparación a las mujeres que no tuvieron ningún embarazo.

```{r}
#| fig.cap: "Distribución de la edad según presencia de diabetes"
ggplot(datos, aes(x = factor(diabetes, 
                                      labels = c("No", "Sí")),
                           y = edad,
                           fill = factor(diabetes, 
                                         labels = c("No", "Sí")))) +
  geom_boxplot(alpha = 0.7, size = 0.3) +
  scale_fill_manual(values = c("No" = "aquamarine", "Sí" = "pink3")) +
  labs(
    x = "Diabetes",
    y = "Edad"
    ) +
  theme(legend.position = "none")  
```

El 50% de las mujeres sin diabetes parece tener entre 23 y 30 años aproximadamente, mientras que el 50% de las mujeres con diabetes tienen entre 27 y 43 años aproximadamente. Esto habla de que las mujeres con diabetes en general tienen una edad mayor a las mujeres sin diabetes.

# Modelado estadístico

El trabajo se realizará bajo el enfoque de modelos lineales generalizados, utilizando lo desarrollado por Nelder y Wedderburn. 

## Selección del modelo

```{r, results='hide'}
# Modelo nulo
modelo0 <- glm(diabetes ~ 1, data = datos_train, family = binomial(link = "logit"))
modelo_full <- glm(diabetes ~ edad + glucosa + presion + dpf + embarazo + obesidad, data = datos_train, family = binomial(link = 'logit'))
# Selección hacia adelante
modelo_forward <- step(modelo0,
                       scope = list(lower = ~ 1, 
                                    upper = ~ edad + glucosa + presion + dpf + embarazo + obesidad),
                       direction = "forward",
                       trace = TRUE,
                       k = 2)

# Selección hacia adelante
modelo_backward <- step(modelo_full,
                       scope = list(lower = ~ 1, 
                                    upper = ~ edad + glucosa + presion + dpf + embarazo + obesidad),
                       direction = "backward",
                       trace = TRUE,k = 2)
summary(modelo_backward)
modelo <- modelo_backward
```

```{r, results='hide'}
datos_train %>%
  count(obesidad, glucosa, diabetes) %>%
  group_by(obesidad) %>%
  mutate(prop = n / sum(n))

datos_train %>%
  count(obesidad, dpf, diabetes) %>%
  group_by(obesidad) %>%
  mutate(prop = n / sum(n))

datos_train %>%
  count(dpf, glucosa, diabetes) %>%
  group_by(dpf) %>%
  mutate(prop = n / sum(n))
```

```{r, results='hide'}
modelo_int <- step(modelo,
                   scope = list(lower = ~ 1, 
                   upper = ~ (edad + glucosa  + dpf  + obesidad)^2,
                       direction = "forward",
                       trace = TRUE,
                       k = 2))
anova(modelo, modelo_int)
# Si bien la selección hacia adelante deja una interacción doble, esta no es significativa según el test de RV
```

Para modelar la probabilidad de presentar diabetes en mujeres mayores a 21 años, en función de las variables explicativas edad, glucosa, presión arterial, DPF, embarazo y obesidad, se propuso emplear un modelo con función de enlace logit.

En primer lugar, se aplicaron los métodos de selección de variables hacia adelante y hacia atrás, eligiendo en cada paso el modelo con menor medida de la información de Akaike (AIC). En ambos casos se obtuvo el mismo modelo final, compuesto únicamente por 4 efectos principales: los de edad, glucosa, DPF y obesidad.

A continuación, se exploró la posibilidad de incorporar interacciones de segundo orden entre las variables explicativas, ajustando un modelo ampliado y comparándolo con el modelo sin interacciones. Dado que la inclusión de interacciones no mejoró el ajuste, se mantuvo el modelo de efectos principales.

El modelo seleccionado se expresa como:

$$
\text{logit}(\pi_i) = \ln\left(\frac{\pi_i}{1 - \pi_i}\right) =
\beta_0 + \beta_1\,\text{Edad}_i + \beta_2\,\text{Glucosa}_i +
\beta_3\,\text{DPF}_i + \beta_4\,\text{Obesidad}_i \quad i=\overline{1,332}
$$

## Bondad del ajuste y estimación del modelo

```{r, results='hide'}
pchisq(modelo$deviance, modelo$df.residual, ncp = 0, lower.tail = FALSE,log.p=FALSE) # creo q esto es con deviance habria que hacer el de hosmer y lemeshow

library(ResourceSelection)

# Prueba de Hosmer y Lemeshow
hoslem.test(x = modelo$y, y = fitted(modelo), g = 10)
```

Para evaluar la bondad de ajuste del modelo, se aplicó la prueba de Hosmer y Lemeshow. Esta prueba compara las frecuencias observadas y esperadas del evento de interés en grupos formados a partir de los valores predichos por el modelo y dado el tamaño muestral disponible, se optó por dividir las observaciones en 10 grupos de igual tamaño según los valores de probabilidad predicha. Finalmente, se concluye que el modelo presenta un ajuste adecuado a los datos ($p-value = 0.7069$).

```{r, eval=FALSE}
probs <- fitted(modelo)
# Working responses
z <- resid(modelo, type = "working") + modelo$linear.predictor

# Gráfico de working responses vs. predictor lineal
ggplot(datos_train, aes(y = modelo$linear.predictor, x = z)) + 
  geom_point(fill = "orange", shape = 21, size = 3) +
  labs(title = "Working responses vs. predictor lineal", x = "Z" , y = expression(eta)) +
  geom_abline(intercept = 0, slope = 1) +
  theme_minimal()  # esto no se incluye
```

```{r, results='hide'}
pred.logit <- predict(modelo)
datos_train$pred.2.logit <- pred.logit*pred.logit
modelo_logit.2 <- glm(diabetes ~ glucosa + obesidad + edad + dpf + pred.2.logit, 
                        family=binomial(link="logit"), 
                        data=datos_train)
anova(modelo, modelo_logit.2, test = 'LRT')
summary(modelo_logit.2)
```

Además, se evaluó la adecuación de la función de enlace logit utilizada en el modelo. Para ello, se aplicó el test de especificación de la función de enlace, que consiste en incorporar al modelo un término adicional cuadrático del predictor lineal estimado:

$$
\begin{aligned}
M1)\quad \text{logit}(\pi_i) &= \beta_0 + \beta_1\,\text{Edad}_i + \beta_2\,\text{Glucosa}_i + 
\beta_3\,\text{DPF}_i + \beta_4\,\text{Obesidad}_i \\
M2)\quad \text{logit}(\pi_i) &= \beta_0 + \beta_1\,\text{Edad}_i + \beta_2\,\text{Glucosa}_i + 
\beta_3\,\text{DPF}_i + \beta_4\,\text{Obesidad}_i + \beta_5\,\hat{\eta}_i^2
\end{aligned}
$$

El procedimiento implica ajustar un modelo extendido que incluye esta nueva variable y comparar su ajuste con el modelo original mediante una prueba de razón de verosimilitud. En este análisis, la comparación entre ambos modelos no mostró evidencia suficiente para rechazar la adecuación del enlace logit, por lo que se considera apropiado mantenerlo en el modelo final ($p-value = 0.6489$).

```{r, results='hide'}
quantile(datos_train$edad, probs = c(0.2,0.4,0.6,0.8))
datos_train <- datos_train %>%
  mutate(
    # Variable ordinal
    edad_ORDEN = case_when(
      edad <= 23 ~ 1,
      edad <= 25 ~ 2,
      edad <= 29 ~ 3,
      edad <= 38 ~ 4,
      T ~ 5
    ),
    
    # Variables dummies
    edad_2 = if_else(edad > 23 & edad <= 25, 1, 0),
    edad_3 = if_else(edad > 25 & edad <= 29, 1, 0),
    edad_4 = if_else(edad > 29 & edad <= 38, 1, 0),
    edad_5 = if_else(edad > 38, 1, 0),
  )

# Modelo con variables dummies de edad
mod_dummies <- glm(diabetes ~ glucosa + obesidad + dpf + edad_2 + edad_3 + edad_4 + edad_5,
                     family = binomial(link = 'logit'), data = datos_train)
summary(mod_dummies)

# Modelo con variable ordinal de edad
mod_orden <- glm(diabetes ~ glucosa + obesidad + dpf + edad_ORDEN,
                     family = binomial(link = 'logit'), data = datos_train)
summary(mod_orden)

# Comparación de modelos
anova(mod_orden, mod_dummies)
# Hay linealidad en la edad
```

Con el objetivo de verificar el supuesto de linealidad entre la variable continua edad y el logit de la probabilidad de presentar diabetes, se implementó una comparación entre dos modelos alternativos.

En primer lugar, se construyó un modelo que incorpora la variable edad como ordinal, dividiendo su rango en cinco categorías según los cuantiles 0.2, 0.4, 0.6 y 0.8. Posteriormente, se ajustó un segundo modelo en el que la edad se representó mediante variables indicadoras (dummies), permitiendo una relación no necesariamente lineal con la respuesta.

El modelo ordinal se puede expresar como:

$$
\quad \text{logit}(\pi_i) =
\beta_0 + \beta_1\,\text{Glucosa}_i +
\beta_2\,\text{Obesidad}_i +
\beta_3\,\text{DPF}_i +
\beta_4\,\text{EdadORDEN}_i
$$

Mientras que el modelo con variables indicadoras se define como:

$$
\quad \text{logit}(\pi_i) =
\beta_0 + \beta_1\,\text{Glucosa}_i +
\beta_2\,\text{Obesidad}_i +
\beta_3\,\text{DPF}_i +
\beta_4\,\text{Edad2}_i +
\beta_5\,\text{Edad3}_i +
\beta_6\,\text{Edad4}_i +
\beta_7\,\text{Edad5}_i
$$
Ambos modelos fueron comparados mediante la prueba de razón de verosimilitud. Dado que la diferencia en el ajuste entre el modelo con edad tratada como ordinal y el modelo con las variables dummies no resultó estadísticamente significativa, se concluye que la relación entre la edad y el logit de la probabilidad de diabetes puede considerarse lineal ($p-value = 0.6408$). Por tanto, se mantiene la variable edad como cuantitativa continua en el modelo final.

Considerando los resultados del estudio del modelo a través de los diferentes tests de hipótesis, el ajuste realizado es el siguiente:

$$
\text{logit}(\hat{\pi_i}) = \ln\left(\frac{\hat{\pi_i}}{1 - \hat{\pi_i}}\right) =
-6.04 + 0.07\cdot\text{Edad}_i + 1.91\cdot\text{Glucosa}_i +
0.98\cdot\text{DPF}_i + 1.47\cdot\text{Obesidad}_i \quad i=\overline{1,332}
$$

## Análisis de residuos

El análisis de residuos permite evaluar la adecuación del modelo ajustado, tanto en lo que respecta a la componente sistemática como a la aleatoria.

Con el objetivo de analizar la estructura del modelo, se construyó el gráfico de los residuos cuantil frente a las probabilidades estimadas bajo el enlace logit. 

\newpage

```{r, fig.cap='Gráfico de residuos cuantil vs. las probabilidades estimadas'}
# Residuos cuantil
rQ <- qresid(modelo)

# Gráfico de residuos cuantil vs. probabilidades estimadas (ajuste cloglog)
ggplot(datos_train, aes(y = rQ, x = fitted(modelo))) + 
  geom_point(fill = "aquamarine3", shape = 21, size = 1.8) +
  geom_hline(yintercept = 0) + ylim(-3, 3) + 
  geom_hline(yintercept = -3, linetype = "dashed") + 
  geom_hline(yintercept =  3, linetype = "dashed") +
  labs(x = expression(hat(pi)), y = "Residuos cuantil") +
  theme_minimal()
```

En este gráfico, la mayoría de los puntos se distribuyen de manera aleatoria alrededor de la línea horizontal en cero, sin evidenciar un patrón sistemático.  
Esto sugiere que la función de enlace logit es adecuada y que el modelo logra capturar correctamente la relación entre las variables explicativas y la probabilidad de presentar diabetes.

Además, para verificar la adecuación de la distribución supuesta de los errores, se empleó un gráfico QQ de los residuos cuantil. 

```{r, fig.cap='Gráfico probabilístico normal con residuos cuantil'}
ggplot(datos_train, aes(sample = rQ)) +
  stat_qq(distribution = qnorm, fill = "aquamarine3", shape = 21, size = 1.8) +
  stat_qq_line() +
  labs(x = "Cuantiles teóricos", y = "Cuantiles de los residuos cuantil") +
  theme_minimal()
```

En dicho gráfico se observa que los puntos siguen aproximadamente la línea de referencia, con ligeras desviaciones en los extremos.  
Por lo tanto, puede concluirse que no existen desviaciones importantes respecto a la distribución esperada, indicando un ajuste razonablemente bueno del modelo.

## Estudio de la capacidad predictiva del modelo

Con el objetivo de evaluar la capacidad predictiva del modelo ajustado, se procedió a dividir la base de datos en dos subconjuntos: un conjunto de entrenamiento, utilizado para estimar los parámetros del modelo, y un conjunto de validación, empleado para evaluar su desempeño sobre observaciones no utilizadas en el ajuste. Esta separación permite obtener una medida más realista de la capacidad del modelo para generalizar a nuevos datos.

A partir de las probabilidades estimadas en el conjunto de validación, se construyó la curva ROC, que representa la sensibilidad y especificidad frente a para distintos puntos de corte. Este gráfico permite analizar el equilibrio entre verdaderos positivos y falsos positivos, siendo un instrumento útil para determinar el umbral óptimo de clasificación.

```{r, fig.cap='Curva ROC'}
datos_train$prob <- predict(modelo, newdata = datos_train, type = "response")

roc_train <- roc(datos_train$diabetes, datos_train$prob)
plot(roc_train, col = "#2E86C1", lwd = 2)
best_cut <- coords(roc_train, "best", ret = "threshold", best.method = "youden")
```

El punto de corte seleccionado fue de 0.377, correspondiente al valor que maximiza simultáneamente la sensibilidad y la especificidad del modelo. Con este umbral se obtuvo la siguiente matriz de confusión, que resume el desempeño del modelo en la clasificación de los casos:

| **Predicho / Observado** | **No diabetes** | **Diabetes** |
| ------------------------ | :-------------: | :----------: |
| **No diabetes**          |        31       |       7      |
| **Diabetes**             |        10       |      11      |

El modelo logró clasificar correctamente al 71% de las observaciones del conjunto de validación, con una sensibilidad del 61% (proporción de diabéticas correctamente identificadas) y una especificidad del 75.6% (proporción de no diabéticas correctamente clasificadas).

```{r}
#| include: false
datos_val$prob <- predict(modelo, newdata = datos_val, type = "response")
datos_val$pred <- ifelse(datos_val$prob > best_cut[1,1], 1, 0)
confusionMatrix(
  factor(datos_val$pred),
  factor(datos_val$diabetes),
  positive = "1"
)
```

# Resultados

En esta sección se presentan los principales hallazgos obtenidos a partir del modelo final ajustado. En primer lugar, se exponen las razones de odds estimadas para cada variable significativa, seguidas por la representación gráfica de las mismas. Posteriormente, se incluyen las curvas ajustadas que ilustran la probabilidad predicha de diabetes bajo diferentes combinaciones de factores.

## Razones de odds

Las razones de odds permiten cuantificar la variación en la probabilidad de padecer diabetes ante cambios en las variables explicativas, manteniendo constantes las demás condiciones.

```{r}
library(plyr)

# Extraemos coeficientes e IC para calcular RO
res <- tidy(modelo, conf.int = TRUE) %>%
  mutate(
    RO = round(exp(estimate), 2),
    IC_inf = round(exp(conf.low), 2),
    IC_sup = round(exp(conf.high), 2),
    # Ajustamos la RO de la edad, para calcularla con un incremento de 5 años
    RO_ajustada = if_else(term == "edad", 
                          round(exp(estimate * 5), 2), RO),
    IC_inf_ajustado = if_else(term == "edad",
                              round(exp(conf.low * 5), 2), IC_inf),
    IC_sup_ajustado = if_else(term == "edad",
                              round(exp(conf.high * 5), 2), IC_sup),
    # Etiquetas más legibles
    term = recode(term,
      "edad" = "Edad (cambio en 5 años)",
      "glucosa1" = "Glucosa (elevada vs. normal)",
      "dpf1" = "DPF (alto vs. bajo)",
      "obesidad1" = "Obesidad (sí vs. no)"
    )
  ) %>% 
  filter(term != "(Intercept)") %>% 
  arrange(desc(RO_ajustada))
```

```{r}
# Tabla de resultados
res_final <- res %>% 
  dplyr::select(term, RO_ajustada, 
                IC_sup_ajustado, IC_inf_ajustado)

res %>%
  dplyr::select(term, RO_ajustada, IC_inf_ajustado, IC_sup_ajustado) %>% 
  kable(
    caption = "Razones de Odds estimadas por el modelo",
    col.names = c("Variable", "$\\hat{RO}$", "Límite inferior", "Límite superior"),
    align = "c",
    format = "latex",
    booktabs = TRUE,
    escape = FALSE
  ) %>%
  add_header_above(
    c(" " = 2, "IC $\\\\hat{RO}$" = 2),
    escape = FALSE) %>%
  kable_styling(
    latex_options = c("hold_position", "caption_position_bottom"),
    full_width = FALSE
  )
```

```{r, fig.cap='Forest plot de Razones de odds (cambios en edad por 5 años)'}
# Gráfico de resultados
ggplot(res, aes(x = RO_ajustada, y = fct_rev(term))) +
  geom_point() +
  geom_errorbarh(aes(xmin = IC_inf_ajustado, xmax = IC_sup_ajustado), height = 0.2) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "aquamarine3", linewidth = 0.8) +
  scale_x_continuous(
    limits = c(0, 20), 
    breaks = c(1, 5, 10, 15, 20)
  ) +
  scale_y_discrete(labels = function(y) gsub(" \\(", "\n(", y)) +
  labs(
    x = "Razón de odds",
    y = "Variable"
  )
```

\newpage

De la Tabla 9 y la Figura 10 se extrae que:

- La chance de tener diabetes para las mujeres con glucosa elevada es entre 3.24 y 15.68 veces la misma chance para mujeres con niveles de glucosa normales, para niveles fijos de obesidad, DPF y misma edad.

- La chance de tener diabetes para mujeres con obesidad es entre 1.25 y 7.85 veces mayor a la misma chance para mujeres sin obesidad, con niveles fijos de glucosa, dpf y misma edad.

- La chance de tener diabetes para mujeres con dpf alto es entre un 54% y un 362% mayor que la misma chance para mujeres con dpf bajo, para niveles fijes de glucosa, obesidad y misma edad.

- La chance de tener diabetes aumenta entre un 26% y un 69% al aumentar la edad de la mujer en 5 años, para niveles fijos de glucosa, obesidad y dpf.

## Probabilidades ajustadas

Las curvas de probabilidades ajustadas permiten visualizar cómo se modifica el riesgo estimado para los diferentes perfiles en estudio y la tendencia creciente de la probabilidad de diabetes con la edad.

```{r}
# Crear grid con todas las combinaciones posibles
nuevo <- expand.grid(
  edad = seq(min(datos$edad), max(datos$edad), by = 1),
  dpf = levels(datos$dpf),
  obesidad = levels(datos$obesidad),
  glucosa = levels(datos$glucosa)
)

# Calcular probabilidades predichas
nuevo$prob <- predict(modelo, newdata = nuevo, type = "response")

# Crear etiqueta combinada
nuevo <- nuevo %>%
  mutate(
    combinacion = paste0("DPF:", dpf, " | Obesidad:", obesidad, " | Glucosa:", glucosa)
  )

# Calcular el valor final de probabilidad para cada combinación
orden_leyenda <- nuevo %>%
  group_by(combinacion) %>%
  filter(edad == max(edad)) %>% 
  arrange(desc(prob)) %>% 
  pull(combinacion)

# Reordenar factor de la leyenda según la probabilidad final
nuevo <- nuevo %>%
  mutate(combinacion = factor(combinacion, levels = orden_leyenda))
```

```{r}
#| fig.cap: "Probabilidad predicha de diabetes según edad y combinación de factores" 
# Graficar
ggplot(nuevo, aes(x = edad, y = prob, color = combinacion)) +
  geom_line(linewidth = 0.6) +
  labs(
    x = "Edad",
    y = "Probabilidad predicha de diabetes",
    color = "Combinación de factores"
  ) +
  lims(y = c(0, 1)) +
  theme(
    legend.position = "right",
    legend.text = element_text(size = 8)
  )

```

Dado que el modelo no contempla interacciones, se observa que para todos los perfiles hay un aumento en la probabilidad de tener diabetes al aumentar la edad de la paciente. Además, se destaca que la curva que está por debajo de las restantes corresponde a las mujeres sin obesidad, con niveles de glucosa normales y un DPF normal, mientras que la curva por encima de las otras, es la de las mujeres con obesidad, niveles de glucosa elevados y un DPF alto.

# Conclusión

El presente trabajo permitió ajustar y evaluar un modelo lineal generalizado con enlace logit para estudiar los factores asociados a la presencia de diabetes en una muestra de mujeres adultas. A través de un proceso de selección, diagnóstico y validación, se obtuvo un modelo parsimonioso y con un buen nivel de ajuste según las pruebas aplicadas.

El análisis evidenció que los niveles de glucosa en ayunas, la obesidad, los antecedentes familiares (DPF) y la edad contribuyen significativamente a explicar la probabilidad de padecer diabetes. La validación del modelo, mediante la curva ROC y la matriz de confusión, mostró una capacidad predictiva adecuada, confirmando su utilidad para clasificar correctamente una proporción importante de los casos.
