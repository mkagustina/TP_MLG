---
fontsize: 11pt 
output: 
  pdf_document: 
    latex_engine: xelatex
    keep_tex: true
    toc: false
    fig_caption: true  
geometry: "left=3cm,right=3cm,top=3cm,bottom=3cm"
#titlepage: true 
lang: es-ES  
editor_options: 
  chunk_output_type: console
header-includes:
  - \usepackage{caption}
  - \captionsetup[table]{position=bottom,labelformat=default,labelsep=colon,name=Tabla}
  - \captionsetup[figure]{labelformat=default,labelsep=colon,name=Figura}
include-in-header:
            - text: |
                \usepackage{float}
                \floatplacement{figure}{H} 
---

\begin{titlepage}
    \centering
    % Logo
    \includegraphics[width=0.7\textwidth]{logo_facultad.png}\par
    % Espacio entre logo y título principal
    \vspace{3cm}
    % Título principal
    {\scshape\Huge Trabajo Práctico de Modelos Lineales Generalizados \par}
    \vfill
    % Carrera y Alumnos
    {\Large Integrantes: \\[0.15cm]
     Candela, Ornella \\[0.15cm]
     Mac Kay, Agustina \\[0.15cm]
     Ovando, Francisco \par}
    \vspace{1cm}
    {\Large Licenciatura en Estadística \par}
    % Fecha abajo del todo
    \vspace{0.15cm}
    {\large Año 2025 \par}
\end{titlepage}


```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.align="center", echo = FALSE, 
                      warning = FALSE, message = FALSE)
```

```{r}
# Carga de librerías
library(readr)
library(tidyverse)
library(skimr)
library(MASS)
library(statmod)
library(kableExtra)
library(pROC)
library(caret)
library(broom) # Extrae info de los modelos ajustados
options(scipen = 8) # Desactiva notación científica
```

```{r}
# Carga de datos
diabetes <- read_csv("diabetes.csv")
```

```{r}
# Modificacion de la base
datos_crudo <- diabetes %>% 
  rename(
    glucosa = "Glucose",
    presion = "BloodPressure",
    piel = "SkinThickness",
    insulina = "Insulin",
    imc = "BMI",
    dpf = "DiabetesPedigreeFunction",
    edad = "Age",
    diabetes = "outcome"
    ) %>%
  filter(
    edad < 80, 
    presion > 0,
    insulina > 0,
    glucosa > 0, 
    imc > 0
    )%>%
  mutate(
    embarazo = factor(case_when(
      Pregnancies == 0 ~ "0",
      Pregnancies <= 3 ~ "1",
      T ~ "2")),
    obesidad = factor(case_when(
      imc < 30 ~ "0",
      T ~ "1")),
    glucosa = factor(case_when(
      glucosa > 100 ~ "1",
      T ~ "0")),
    presion = factor(case_when(
      presion > 80 ~ "1",
      T ~ "0")),
    dpf = factor(case_when(
      dpf > 0.5 ~ "1",
      T ~ "0"))
    )

datos <-  datos_crudo %>% 
  dplyr::select(edad, glucosa, presion, dpf, embarazo, obesidad,
                diabetes)
```

```{r}
# Separación del dataset en training y validation sets
set.seed(8)

# Training set
datos_train <- datos %>% slice_sample(prop = 0.85)

# Validation set
datos_val <- datos %>% 
  filter(!row_number() %in% as.numeric(rownames(datos_train)))
```

## Introducción

La diabetes es una enfermedad metabólica crónica caracterizada por niveles elevados de glucosa en sangre, consecuencia de una producción insuficiente de insulina o de una resistencia del organismo a su acción. Esta condición puede derivar en complicaciones cardiovasculares, renales, neurológicas y visuales, afectando de manera significativa la calidad de vida de quienes la padecen.

Dada la relevancia de esta enfermedad en términos de salud pública y su estrecha relación con factores fisiológicos y de estilo de vida, resulta fundamental comprender qué características individuales se asocian a un mayor riesgo de padecerla.

## Material y métodos

El presente trabajo tiene como objetivo analizar los factores asociados a la presencia de diabetes en mujeres mayores de 21 años, a través de un modelo lineal generalizado con respuesta binaria. La variable respuesta analizada toma el valor 1 si la persona presenta diagnóstico de diabetes y 0 en caso contrario, por lo que se asume una distribución Bernoulli para cada observación.

Las variables explicativas incluidas en el análisis se describen a continuación:

\begin{itemize}
  \item Edad: medida en años. Es una variable cuantitativa continua que permite evaluar el efecto del envejecimiento sobre la probabilidad de desarrollar diabetes.

  \item Embarazo: número de veces que la mujer ha estado embarazada, categorizada en tres niveles:
  \begin{itemize}
    \item “0”: ninguna gestación
    \item “1”: entre una y tres gestaciones
    \item “2”: más de tres gestaciones
  \end{itemize}

  \item Glucosa: concentración de glucosa en ayunas. Fue categorizada en dos niveles:
  \begin{itemize}
    \item “0”: valores normales (≤ 100 mg/dL)
    \item “1”: valores elevados (> 100 mg/dL)
  \end{itemize}

  \item Presión arterial: presión diastólica medida en mmHg, clasificada en dos niveles:
  \begin{itemize}
    \item “0”: presión dentro del rango normal (≤ 80 mmHg)
    \item “1”: presión elevada (> 80 mmHg)
  \end{itemize}

  \item Obesidad: medida a través del índice de masa corporal (IMC). Se definió con dos niveles:
  \begin{itemize}
    \item “0”: IMC menor a 30
    \item “1”: IMC igual o superior a 30
  \end{itemize}

  \item DPF (Diabetes Pedigree Function): índice que cuantifica la predisposición genética a la diabetes a partir del historial familiar. Fue dicotomizado en:
  \begin{itemize}
    \item “0”: valores bajos (≤ 0.5)
    \item “1”: valores altos (> 0.5)
  \end{itemize}
\end{itemize}

## Análisis descriptivo

A continuación se presenta una visión general de las características clave de la población estudiada.

```{r}
# Frecuencias absolutas y relativas de DIABETES
tabla_respuesta <- datos %>%
  count(diabetes) %>%
  mutate(
    Categoria = ifelse(diabetes == 1, "Sí", "No"),
    Porcentaje = round(100 * n / sum(n), 2)
  ) %>%
  dplyr::select(Categoria, Frecuencia = n, Porcentaje) %>%
  # Agregar fila de totales
  rbind(c("Total", sum(.$Frecuencia), 100))

# Mostrar tabla 
tabla_respuesta %>%
  kable(
    caption = "Frecuencias absolutas y relativas de diabetes",
    col.names = c("Diabetes", "Frecuencia", "Porcentaje (%)"),
    align = "c",
    format = "latex",     
    booktabs = TRUE       
  ) %>%
  kable_styling(
    latex_options = c("hold_position", "caption_position_bottom"),
    full_width = FALSE
  )
```

```{r, eval=FALSE}
# resumen general de variables
skim(datos)
```

```{r}
# Analisis variables explicativas categoricas

# Frecuencias absolutas y relativas de OBESIDAD
tabla_obesidad <- datos %>%
  count(obesidad) %>%
  mutate(
    Categoria = case_when(
      obesidad == 0 ~ "Peso Normal o sobrepeso",
      obesidad == 1 ~ "Obesidad",
    ),
    Porcentaje = round(100 * n / sum(n), 2)
  ) %>%
  dplyr::select(Categoria, Frecuencia = n, Porcentaje) %>% 
  # Agregar fila de totales
  rbind(c("Total", sum(.$Frecuencia), 100))

# Mostrar tabla 
tabla_obesidad %>%
  kable(
    caption = "Frecuencias absolutas y relativas de obesidad",
    col.names = c("Obesidad", "Frecuencia", "Porcentaje (%)"),
    align = "c",
    format = "latex",    
    booktabs = TRUE       
  ) %>%
  kable_styling(
    latex_options = c("hold_position", "caption_position_bottom"),
    full_width = FALSE
  )
```


```{r}
# Frecuencias absolutas y relativas de GLUCOSA
tabla_glucosa <- datos %>%
  count(glucosa) %>%
  mutate(
    Categoria = ifelse(glucosa == 1, "Elevada", "Normal"),
    Porcentaje = round(100 * n / sum(n), 2)
  ) %>%
  dplyr::select(Categoria, Frecuencia = n, Porcentaje) %>% 
  # Agregar fila de totales
  rbind(c("Total", sum(.$Frecuencia), 100))

# Mostrar tabla 
tabla_glucosa %>%
  kable(
    caption = "Frecuencias absolutas y relativas de glucosa",
    col.names = c("Glucosa", "Frecuencia", "Porcentaje (%)"),
    align = "c",
    format = "latex",     
    booktabs = TRUE       
  ) %>%
  kable_styling(
    latex_options = c("hold_position", "caption_position_bottom"),
    full_width = FALSE
  )
```


```{r}
# Frecuencias absolutas y relativas de PRESION
tabla_presion <- datos %>%
  count(presion) %>%
  mutate(
    Categoria = ifelse(presion == 1, "Elevada", "Normal"),
    Porcentaje = round(100 * n / sum(n), 2)
  ) %>%
  dplyr::select(Categoria, Frecuencia = n, Porcentaje) %>% 
  # Agregar fila de totales
  rbind(c("Total", sum(.$Frecuencia), 100))

# Mostrar tabla 
tabla_presion %>%
  kable(
    caption = "Frecuencias absolutas y relativas de presión",
    col.names = c("Presión", "Frecuencia", "Porcentaje (%)"),
    align = "c",
    format = "latex",     
    booktabs = TRUE       
  ) %>%
  kable_styling(
    latex_options = c("hold_position", "caption_position_bottom"),
    full_width = FALSE
  )
```


```{r}
# Frecuencias absolutas y relativas de DPF
tabla_dpf <- datos %>%
  count(dpf) %>%
  mutate(
    Categoria = ifelse(dpf == 1, "Riesgo alto", "Riesgo bajo"),
    Porcentaje = round(100 * n / sum(n), 2)
  ) %>%
  dplyr::select(Categoria, Frecuencia = n, Porcentaje) %>% 
  # Agregar fila de totales
  rbind(c("Total", sum(.$Frecuencia), 100))

# Mostrar tabla 
tabla_dpf %>%
  kable(
    caption = "Frecuencias absolutas y relativas de DPF",
    col.names = c("DPF", "Frecuencia", "Porcentaje (%)"),
    align = "c",
    format = "latex",     
    booktabs = TRUE       
  ) %>%
  kable_styling(
    latex_options = c("hold_position", "caption_position_bottom"),
    full_width = FALSE
  )
```


```{r}
# Frecuencias absolutas y relativas de EMBARAZO
tabla_embarazo <- datos %>%
  count(embarazo) %>%
  mutate(
    Categoria = case_when(
      embarazo == 0 ~ "Ninguno",
      embarazo == 1 ~ "1 a 3",
      embarazo == 2 ~ "Más de 3",
    ),
    Porcentaje = round(100 * n / sum(n), 2)
  ) %>%
  dplyr::select(Categoria, Frecuencia = n, Porcentaje) %>% 
  # Agregar fila de totales
  rbind(c("Total", sum(.$Frecuencia), 100))

# Mostrar tabla 
tabla_embarazo %>%
  kable(
    caption = "Frecuencias absolutas y relativas de embarazo",
    col.names = c("Embarazos", "Frecuencia", "Porcentaje (%)"),
    align = "c",
    format = "latex",    
    booktabs = TRUE       
  ) %>%
  kable_styling(
    latex_options = c("hold_position", "caption_position_bottom"),
    full_width = FALSE
  )
```


```{r}
# Tabla descriptiva de edad
tabla_edad <- datos %>%
  summarise(
    Media_edad = round(mean(edad),2),
    Mediana_edad = median(edad),
    DE_edad = round(sd(edad),2),
    Min_edad = min(edad),
    Max_edad = max(edad)
  ) %>%
  pivot_longer(everything()) %>%
  separate(name, into = c("Estadístico", "Variable"), sep = "_") %>%
  pivot_wider(names_from = Estadístico, values_from = value) %>%
  mutate(
    Variable = case_when(
      Variable == "edad" ~ "Edad",
      TRUE ~ Variable
    )
  ) %>%
  dplyr::select(Variable, Media, Mediana, DE, Min, Max)

# Mostrar tabla en formato LaTeX
tabla_edad %>%
  kable(
    caption = "Estadísticas descriptivas de la variable edad",
    col.names = c("Variable", "Media", "Mediana", "DE", "Mínimo", "Máximo"),
    align = "c",
    format = "latex",
    booktabs = TRUE
  ) %>%
  kable_styling(
    latex_options = c("hold_position", "caption_position_bottom"),
    full_width = FALSE
  )
```

\newpage

Los datos muestran que un 33.2% de la población estudiada tiene diabetes, con una alta prevalencia de obesidad (67%) y niveles elevados de glucosa (70.3%). Además, el 43% de los participantes tiene antecedentes familiares de diabetes, lo que podría indicar una predisposición genética relevante. Aunque la mayoría presenta presión arterial normal (80.1%), los factores como la obesidad, los niveles de glucosa y el historial familiar podrían ser más críticos para entender el riesgo de diabetes en esta población. 

Seguidamente, se presentan gráficos que permiten observar la relación entre la variable respuesta (presencia de diabetes) y distintas variables explicativas categóricas y continuas. Esta visualización facilita la detección de posibles asociaciones y patrones relevantes para el posterior análisis.

```{r, fig.height=8}
# Cruzamos las categóricas con la respuesta

# OBESIDAD
graf2 <- ggplot(datos, aes(x = obesidad, fill = factor(diabetes))) +
  geom_bar(position = "fill", width = 0.7) +
  scale_fill_manual(
    values = c("aquamarine3", "pink3"),
    name = "Diabetes",
    labels = c("No", "Sí")
  ) +
  scale_x_discrete(
    labels = c(`0` = "Peso Normal o sobrepeso", `1` = "Obesidad")
  ) +
  labs(
    x = "Nivel de obesidad",
    y = "Proporción",
    caption = "Figura 1: Proporción de personas con diabetes según nivel de obesidad"
  ) +
  theme_minimal(base_size = 9)

# PRESIÓN
graf3 <- ggplot(datos, aes(x = presion, fill = factor(diabetes))) +
  geom_bar(position = "fill", width = 0.7) +
  scale_fill_manual(
    values = c("aquamarine3", "pink3"),
    name = "Diabetes",
    labels = c("No", "Sí")
  ) +
  scale_x_discrete(
    labels = c(`0` = "Normal", `1` = "Elevada")
  ) +
  labs(
    x = "Presión",
    y = "Proporción",
    caption = "Figura 2: Proporción de personas con diabetes según presión"
  ) +
  theme_minimal(base_size = 9)

# DPF
graf4 <- ggplot(datos, aes(x = dpf, fill = factor(diabetes))) +
  geom_bar(position = "fill", width = 0.7) +
  scale_fill_manual(
    values = c("aquamarine3", "pink3"),
    name = "Diabetes",
    labels = c("No", "Sí")
  ) +
  scale_x_discrete(
    labels = c(`0` = "Riesgo bajo", `1` = "Riesgo alto")
  ) +
  labs(
    x = "DPF",
    y = "Proporción",
    caption = "Figura 3: Proporción de personas con diabetes según DPF"
  ) +
  theme_minimal(base_size = 9)

# GLUCOSA
graf5 <- ggplot(datos, aes(x = glucosa, fill = factor(diabetes))) +
  geom_bar(position = "fill", width = 0.7) +
  scale_fill_manual(
    values = c("aquamarine3", "pink3"),
    name = "Diabetes",
    labels = c("No", "Sí")
  ) +
  scale_x_discrete(
    labels = c(`0` = "Normal", `1` = "Elevada")
  ) +
  labs(
    x = "Nivel de glucosa",
    y = "Proporción",
    caption = "Figura 4: Proporción de personas con diabetes según nivel de glucosa"
  ) +
  theme_minimal(base_size = 9)

# EMBARAZOS
graf6 <- ggplot(datos, aes(x = embarazo, fill = factor(diabetes))) +
  geom_bar(position = "fill", width = 0.7) +
  scale_fill_manual(
    values = c("aquamarine3", "pink3"),
    name = "Diabetes",
    labels = c("No", "Sí")
  ) +
  scale_x_discrete(
    labels = c(`0` = "Ninguno", `1` = "1 a 3", `2` = "3 o más")
  ) +
  labs(
    x = "Cantidad de embarazos",
    y = "Proporción",
    caption = "Figura 5: Proporción de personas con diabetes según cantidad de embarazos"
  ) +
  theme_minimal(base_size = 9)

# EDAD
graf7 <- ggplot(datos, aes(x = factor(diabetes, 
                                      labels = c("No", "Sí")),
                           y = edad,
                           fill = factor(diabetes, 
                                         labels = c("No", "Sí")))) +
  geom_boxplot(alpha = 0.7, size = 0.3) +
  scale_fill_manual(values = c("No" = "aquamarine", "Sí" = "pink3")) +
  labs(
    x = "Diabetes",
    y = "Edad",
    caption = "Figura 6: Distribución de la edad según presencia de diabetes"
  ) +
  theme_minimal(base_size = 9) +
  theme(legend.position = "none")  


library(gridExtra)
grid.arrange(graf2, graf3, graf4, graf5, graf6, graf7, 
             ncol=2, nrow = 3)
```

\newpage

Se observa una mayor proporción de casos con diabetes en personas con obesidad, glucosa elevada, riesgo alto en DPF y aquellas con más de tres embarazos. Asimismo, la edad tiende a ser mayor en personas con diabetes. Estas relaciones sugieren que dichas variables podrían tener efecto sobre la probabilidad de desarrollar la enfermedad.

## Selección del modelo

```{r, results='hide'}
# Modelo nulo
modelo0 <- glm(diabetes ~ 1, data = datos_train, family = binomial(link = "logit"))
modelo_full <- glm(diabetes ~ edad + glucosa + presion + dpf + embarazo + obesidad, data = datos_train, family = binomial(link = 'logit'))
# Selección hacia adelante
modelo_forward <- step(modelo0,
                       scope = list(lower = ~ 1, 
                                    upper = ~ edad + glucosa + presion + dpf + embarazo + obesidad),
                       direction = "forward",
                       trace = TRUE,
                       k = 2)

# Selección hacia adelante
modelo_backward <- step(modelo_full,
                       scope = list(lower = ~ 1, 
                                    upper = ~ edad + glucosa + presion + dpf + embarazo + obesidad),
                       direction = "backward",
                       trace = TRUE,k = 2)
summary(modelo_backward)
modelo <- modelo_backward
```

```{r, results='hide'}
datos_train %>%
  count(obesidad, glucosa, diabetes) %>%
  group_by(obesidad) %>%
  mutate(prop = n / sum(n))

datos_train %>%
  count(obesidad, dpf, diabetes) %>%
  group_by(obesidad) %>%
  mutate(prop = n / sum(n))

datos_train %>%
  count(dpf, glucosa, diabetes) %>%
  group_by(dpf) %>%
  mutate(prop = n / sum(n))
```

```{r, results='hide'}
modelo_int <- step(modelo,
                   scope = list(lower = ~ 1, 
                   upper = ~ (edad + glucosa  + dpf  + obesidad)^2,
                       direction = "forward",
                       trace = TRUE,
                       k = 2))
```

Para modelar la probabilidad de presentar diabetes se empleó un modelo lineal generalizado con función de enlace logit, dado que la variable respuesta es dicotómica (1 = presencia de diabetes, 0 = ausencia).

En primer lugar, se ajustó un modelo nulo, que incluye únicamente el intercepto, y un modelo completo que incorpora todas las variables explicativas consideradas: edad, glucosa, presión arterial, DPF, embarazo y obesidad.

Posteriormente, se aplicaron procedimientos automáticos de selección de variables mediante los criterios de información AIC, utilizando los métodos de selección hacia adelante y hacia atrás. En ambos casos se obtuvo el mismo modelo final, compuesto únicamente por efectos principales.

A continuación, se exploró la posibilidad de incorporar interacciones de segundo orden entre las variables explicativas, ajustando un modelo ampliado y comparándolo con el modelo sin interacciones. Dado que la inclusión de interacciones no mejoró el ajuste, se mantuvo el modelo con efectos simples.

El modelo lineal generalizado seleccionado se expresa como:

$$
\text{logit}(\pi_i) = \ln\left(\frac{\pi_i}{1 - \pi_i}\right) =
\beta_0 + \beta_1\,\text{Edad}_i + \beta_2\,\text{Glucosa}_i +
\beta_3\,\text{DPF}_i + \beta_4\,\text{Obesidad}_i
$$



```{r, results='hide'}
pchisq(modelo$deviance, modelo$df.residual, ncp = 0, lower.tail = FALSE,log.p=FALSE) # creo q esto es con deviance habria que hacer el de hosmer y lemeshow

library(ResourceSelection)

# Prueba de Hosmer y Lemeshow
hoslem.test(x = modelo$y, y = fitted(modelo), g = 10)
```

Para evaluar la bondad de ajuste del modelo seleccionado, se aplicó la prueba de Hosmer y Lemeshow.
Esta prueba compara las frecuencias observadas y esperadas del evento de interés en grupos formados a partir de los valores predichos por el modelo.

Dado el tamaño muestral disponible, se optó por dividir las observaciones en 10 grupos de igual tamaño según los valores de probabilidad predicha.

Finalmente, se concluye que el modelo presenta un ajuste adecuado a los datos ($p-value = 0.7069$).

```{r, eval=FALSE}
probs <- fitted(modelo)
# Working responses
z <- resid(modelo, type = "working") + modelo$linear.predictor

# Gráfico de working responses vs. predictor lineal
ggplot(datos_train, aes(y = modelo$linear.predictor, x = z)) + 
  geom_point(fill = "orange", shape = 21, size = 3) +
  labs(title = "Working responses vs. predictor lineal", x = "Z" , y = expression(eta)) +
  geom_abline(intercept = 0, slope = 1) +
  theme_minimal()  # esto no se incluye
```

```{r, results='hide'}
pred.logit <- predict(modelo)
datos_train$pred.2.logit <- pred.logit*pred.logit
modelo_logit.2 <- glm(diabetes ~ glucosa + obesidad + edad + dpf + pred.2.logit, 
                        family=binomial(link="logit"), 
                        data=datos_train)
anova(modelo, modelo_logit.2, test = 'LRT')
summary(modelo_logit.2)
```

Además, se evaluó la adecuación de la función de enlace logit utilizada en el modelo.
Para ello, se aplicó el test de especificación de la función de enlace, que consiste en incorporar al modelo un término adicional cuadrático del predictor lineal estimado:

$$
\begin{aligned}
M1)\quad \text{logit}(\pi_i) &= \beta_0 + \beta_1\,\text{Edad}_i + \beta_2\,\text{Glucosa}_i + 
\beta_3\,\text{DPF}_i + \beta_4\,\text{Obesidad}_i \\
M2)\quad \text{logit}(\pi_i) &= \beta_0 + \beta_1\,\text{Edad}_i + \beta_2\,\text{Glucosa}_i + 
\beta_3\,\text{DPF}_i + \beta_4\,\text{Obesidad}_i + \beta_5\,\hat{\eta}_i^2
\end{aligned}
$$

El procedimiento implica ajustar un modelo extendido que incluye esta nueva variable y comparar su ajuste con el modelo original mediante una prueba de razón de verosimilitud.

En este análisis, la comparación entre ambos modelos no mostró evidencia suficiente para rechazar la adecuación del enlace logit, por lo que se considera apropiado mantenerlo en el modelo final ($p-value = 0.6489$).

```{r, results='hide'}
quantile(datos_train$edad, probs = c(0.2,0.4,0.6,0.8))
datos_train <- datos_train %>%
  mutate(
    # Variable ordinal
    edad_ORDEN = case_when(
      edad <= 23 ~ 1,
      edad <= 25 ~ 2,
      edad <= 29 ~ 3,
      edad <= 38 ~ 4,
      T ~ 5
    ),
    
    # Variables dummies
    edad_2 = if_else(edad > 23 & edad <= 25, 1, 0),
    edad_3 = if_else(edad > 25 & edad <= 29, 1, 0),
    edad_4 = if_else(edad > 29 & edad <= 38, 1, 0),
    edad_5 = if_else(edad > 38, 1, 0),
  )

# Modelo con variables dummies de edad
mod_dummies <- glm(diabetes ~ glucosa + obesidad + dpf + edad_2 + edad_3 + edad_4 + edad_5,
                     family = binomial(link = 'logit'), data = datos_train)
summary(mod_dummies)

# Modelo con variable ordinal de edad
mod_orden <- glm(diabetes ~ glucosa + obesidad + dpf + edad_ORDEN,
                     family = binomial(link = 'logit'), data = datos_train)
summary(mod_orden)

# Comparación de modelos
anova(mod_orden, mod_dummies)
# Hay linealidad en la edad
```

Con el objetivo de verificar el supuesto de linealidad entre la variable continua edad y el logit de la probabilidad de presentar diabetes, se implementó una comparación entre dos modelos alternativos.

En primer lugar, se construyó un modelo que incorpora la variable edad como ordinal, dividiendo su rango en cinco categorías según los cuantiles 0.2, 0.4, 0.6 y 0.8. Posteriormente, se ajustó un segundo modelo en el que la edad se representó mediante variables indicadoras (dummies), permitiendo una relación no necesariamente lineal con la respuesta.

El modelo ordinal se puede expresar como:

$$
\quad \text{logit}(\pi_i) =
\beta_0 + \beta_1\,\text{Glucosa}_i +
\beta_2\,\text{Obesidad}_i +
\beta_3\,\text{DPF}_i +
\beta_4\,\text{EdadORDEN}_i
$$

Mientras que el modelo con variables indicadoras se define como:

$$
\quad \text{logit}(\pi_i) =
\beta_0 + \beta_1\,\text{Glucosa}_i +
\beta_2\,\text{Obesidad}_i +
\beta_3\,\text{DPF}_i +
\beta_4\,\text{Edad2}_i +
\beta_5\,\text{Edad3}_i +
\beta_6\,\text{Edad4}_i +
\beta_7\,\text{Edad5}_i
$$

Ambos modelos fueron comparados mediante la prueba de razón de verosimilitud. Dado que la diferencia en el ajuste entre el modelo con edad tratada como ordinal y el modelo con las variables dummies no resultó estadísticamente significativa, se concluye que la relación entre la edad y el logit de la probabilidad de diabetes puede considerarse lineal ($p-value = 0.6408$). Por tanto, se mantiene la variable edad como cuantitativa continua en el modelo final.

## Curvas ajustadas

```{r}
# Calcular probabilidades predichas
datos_train$prob <- predict(modelo, datos_train, type = "response")
# Crear grid de edades (por ejemplo de 20 a 80)
nuevo <- data.frame(
  edad = seq(min(datos_train$edad), max(datos_train$edad), by = 1),
  dpf = factor(1, levels = levels(datos_train$dpf)),
  obesidad = factor(1, levels = levels(datos_train$obesidad)),
  glucosa = factor(1, levels = levels(datos_train$glucosa))
)

# Calcular probabilidades predichas manteniendo los demás factores en 0
nuevo$prob <- predict(modelo, newdata = nuevo, type = "response")

# Graficar
ggplot(nuevo, aes(x = edad, y = prob)) +
  geom_line(size = 1.1, color = "#0072B2") +
  labs(
    x = "Edad",
    y = "Probabilidad predicha de diabetes",
    title = "Probabilidad de diabetes según edad (dpf, obesidad y glucosa en 0)"
  ) +
  lims(y = c(0, 1)) +
  theme_minimal(base_size = 13)
```


## Análisis de residuos

### Evaluación de la componente sistemática
Observe como se ve el gráfico de los residuos vs. las medias estimadas bajo el enlace logit:
```{r}
# Residuos cuantil
rQ <- qresid(modelo)

# Mu estimado

### Gráfico de residuos cuantil vs. probabilidades estimadas (ajuste cloglog)
ggplot(datos_train, aes(y = rQ, x = fitted(modelo))) + 
  geom_point(fill = "aquamarine3", shape = 21, size = 3) +
  geom_hline(yintercept = 0) + ylim(-3, 3) + 
  geom_hline(yintercept = -3, linetype = "dashed") + 
  geom_hline(yintercept =  3, linetype = "dashed") +
  labs(title = "Gráfico de residuos cuantil vs. las probabilidades estimadas", x = expression(hat(pi)), y = "Residuos cuantil") +
  theme_minimal()
```

### Evaluación de la componente aleatoria

Mediante un gráfico QQ puede evaluarse si la distribución supuesta es adecuada.

```{r, fig.width = 4*1.33*2}
ggplot(datos_train, aes(sample = rQ)) +
  stat_qq(distribution = qnorm, fill = "aquamarine3", shape = 21, size = 3) +
  stat_qq_line() +
  labs(title = "Gráfico probabilístico normal con residuos deviance est.",  x = "Cuantiles teóricos", y = "Cuantiles de los residuos dev. est.") +
  theme_minimal()
```

## Capacidad predictiva del modelo

```{r}

# 1️⃣ Predecir probabilidades sobre el conjunto de validación
datos_train$prob <- predict(modelo, newdata = datos_train, type = "response")

roc_train <- roc(datos_train$diabetes, datos_train$prob)
plot(roc_train, col = "#2E86C1", lwd = 2, main = "Curva ROC (datos de validación)")
best_cut <- coords(roc_train, "best", ret = "threshold", best.method = "youden")
best_cut

datos_val$prob <- predict(modelo, newdata = datos_val, type = "response")
datos_val$pred <- ifelse(datos_val$prob > best_cut[1,1], 1, 0)
confusionMatrix(
  factor(datos_val$pred),
  factor(datos_val$diabetes),
  positive = "1"
)
```

## Resultados

### Razones de odds

```{r}
# Extraemos coeficientes e IC para calcular RO
res <- tidy(modelo, conf.int = TRUE) %>%
  mutate(
    RO = exp(estimate),
    IC_inf = exp(conf.low),
    IC_sup = exp(conf.high),
    # Ajustamos la RO de la edad, para calcularla con un incremento de 5 años
    RO_ajustada = if_else(term == "edad", 
                          exp(estimate * 5), RO),
    IC_inf_ajustado = if_else(term == "edad",
                              exp(conf.low * 5), IC_inf),
    IC_sup_ajustado = if_else(term == "edad",
                              exp(conf.high * 5), IC_sup),
    # Etiquetas más legibles
    term = recode(term,
      "edad" = "Edad (cambio en 5 años)",
      "glucosa1" = "Glucosa (elevada vs. normal)",
      "dpf1" = "DPF (alto vs. bajo)",
      "obesidad1" = "Obesidad (sí vs. no)"
    )
  ) %>% 
  filter(term != "(Intercept)") %>% 
  arrange(desc(RO_ajustada))
```

```{r}
# Tabla de resultados
res_final <- res %>% 
  dplyr::select(term, RO_ajustada, 
                IC_sup_ajustado, IC_inf_ajustado)

library(kableExtra)
library(dplyr)
library(plyr)

res %>%
  dplyr::select(term, RO_ajustada, IC_inf_ajustado, IC_sup_ajustado) %>% 
  kable(
    caption = "Razones de Odds estimadas por el modelo",
    col.names = c("Variable", "$\\widehat{RO}$", "Límite inferior", "Límite superior"),
    align = "c",
    format = "latex",
    booktabs = TRUE,
    escape = FALSE
  ) %>%
  add_header_above(
    c(" " = 2, "IC de $\\widehat{RO}$" = 2),
    escape = FALSE) %>%
  kable_styling(
    latex_options = c("hold_position", "caption_position_bottom"),
    full_width = FALSE
  )

# Gráfico de resultados
ggplot(res, aes(x = RO_ajustada, y = fct_rev(term))) +
  geom_point() +
  geom_errorbarh(aes(xmin = IC_inf_ajustado, xmax = IC_sup_ajustado), height = 0.2) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "aquamarine3", linewidth = 0.8) +
  scale_x_log10() +
  labs(
    x = "Razón de odds",
    y = "Variable",
    title = "Forest plot de Razones de odds (cambios en edad por 5 años)"
  ) +
  theme_minimal()
```


## Conclusión
